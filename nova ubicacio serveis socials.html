<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mapa Serveis Socials Alcoi</title>
    
    <!-- Librería MapLibre GL JS -->
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />

    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        
        /* Contenedor del Mapa */
        #map {
            position: fixed;
            top: 0;
            bottom: 0;
            width: 100%;
            z-index: 0;
            background-color: #e0f7fa;
        }

        /* --- FILTRE BLAU TÈCNIC --- */
        #map canvas {
            filter: grayscale(100%) sepia(100%) hue-rotate(160deg) saturate(2.5) brightness(1.1) contrast(0.9);
            transition: filter 0.5s ease;
        }

        /* Estils del Popup personalitzats per a mòbil */
        .maplibregl-popup {
            max-width: 85vw !important;
            z-index: 10;
        }

        .maplibregl-popup-content {
            padding: 0;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border: 1px solid #005f7f;
            background: rgba(255, 255, 255, 0.95);
        }

        .popup-header {
            background-color: #00b1ea; 
            color: white;
            padding: 12px 15px;
            font-size: 1.1rem;
            font-weight: bold;
            border-bottom: 2px solid #008cb9;
            /* Asegurar espacio para el botón de cerrar */
            padding-right: 40px; 
        }

        .popup-body {
            padding: 15px;
            color: #333;
        }

        .popup-row {
            margin-bottom: 8px;
            display: flex;
            align-items: flex-start;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .popup-row strong {
            color: #008cb9; 
            margin-right: 5px;
            min-width: 60px;
        }

        .popup-img-container {
            margin-top: 10px;
            width: 100%;
            min-height: 100px; 
            background-color: #f9f9f9;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .popup-img {
            width: 100%;
            height: auto;
            max-height: 200px; 
            object-fit: contain; 
            display: block;
        }

        /* Botó de tancar popup */
        .maplibregl-popup-close-button {
            font-size: 28px; /* Un poco más grande para dedos */
            color: white;
            right: 8px;
            top: 8px;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            z-index: 20;
        }
        .maplibregl-popup-close-button:hover {
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
        }

        /* Loading spinner */
        .spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 3px solid #f3f3f3;
            border-top: 3px solid #00b1ea; 
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            z-index: 1;
        }

        @keyframes spin { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); } }

    </style>
</head>
<body>

    <div id="map"></div>

    <script>
        // API KEY
        const apiKey = 'iDTQZVhITfzwL0fI4pCY';

        // Dades
        const centrosData = {
            "type": "FeatureCollection",
            "features": [
                {
                    "type": "Feature",
                    "properties": {
                        "Nombre": "Centre d'Atenció 01",
                        "Calle": "Carrer el Camí, 40, 03801 Alcoi, Alacant",
                        "Barrios": "Centre, la Zona Alta, Viaducte, Batoi, Els Clots, carrer Oliver i part de Santa Rosa, Rambla Alta, Rambla Baixa, Font Roja, Regadiu, Estepar i Riquer Alt.",
                        "Foto": "https://lh3.googleusercontent.com/gps-cs-s/AHVAweqAwzZMGwDK2VPzLP38Uf6LBug3_BSc2XXBWxoSZiaAKqWjZ_VrPnkS5Ri3JsmsMr7XNF_wLQGlU-VCFvu1YPJdo524e-TMUd_rhxVme9XsXlWml5sDbPZQ-Z9-yvYOwDGQ5Bl5=w408-h305-k-no"
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [-0.4757252, 38.6930737]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "Nombre": "Centre d'Atenció 02",
                        "Calle": "Av. Andalusia, 13, 03804 Alcoi, Alacant",
                        "Barrios": "Zona Nord, part de l’Eixample que limita amb el carrer Anselm Aracil, Sol i Camp, Serelles i les Cases del Salt.",
                        "Foto": "https://streetviewpixels-pa.googleapis.com/v1/thumbnail?panoid=iMrvR9nAe6q9cFYiumUxPQ&cb_client=search.gws-prod.gps&w=408&h=240&yaw=292.4843&pitch=0&thumbfov=100" 
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [-0.4675641, 38.7058459]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "Nombre": "Centre d'Atenció 03",
                        "Calle": "Carrer Isabel la Catòlica, 5, 03803 Alcoi, Alacant",
                        "Barrios": "Santa Rosa, l’Eixample, Montesol, Baradello, el Sergent i Barxell.",
                        "Foto": "https://streetviewpixels-pa.googleapis.com/v1/thumbnail?panoid=VsYpi_Z3Bk8zBNmudZG7fw&cb_client=search.gws-prod.gps&w=408&h=240&yaw=200.26553&pitch=0&thumbfov=100"
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [-0.4785047, 38.6997393]
                    }
                }
            ]
        };

        const backupImage = "https://images.unsplash.com/photo-1486406146926-c627a92ad1ab?auto=format&fit=crop&w=400&q=80";

        const initialView = {
            center: [-0.473, 38.700],
            zoom: 13
        };

        const map = new maplibregl.Map({
            container: 'map',
            style: `https://api.maptiler.com/maps/streets-v2/style.json?key=${apiKey}`,
            center: initialView.center, 
            zoom: initialView.zoom,
            attributionControl: false
        });

        map.addControl(new maplibregl.NavigationControl(), 'top-right');
        map.addControl(new maplibregl.AttributionControl({ compact: true }), 'bottom-right');

        let currentPopup = null;

        // Funció per tornar a la vista general
        const resetMap = () => {
            map.flyTo({
                center: initialView.center,
                zoom: initialView.zoom,
                offset: [0, 0], // Aseguramos que el offset se resetee al volver
                essential: true
            });
            currentPopup = null;
        };

        map.on('load', () => {
            
            map.addSource('centros-sociales', {
                'type': 'geojson',
                'data': centrosData
            });

            // Punts
            map.addLayer({
                'id': 'centros-puntos',
                'type': 'circle',
                'source': 'centros-sociales',
                'paint': {
                    'circle-radius': 10,
                    'circle-color': '#e0f7fa', 
                    'circle-stroke-width': 3,
                    'circle-stroke-color': '#00b1ea', 
                    'circle-opacity': 1
                }
            });

            // Halo
            map.addLayer({
                'id': 'centros-halo',
                'type': 'circle',
                'source': 'centros-sociales',
                'beforeId': 'centros-puntos',
                'paint': {
                    'circle-radius': 20,
                    'circle-color': '#00b1ea', 
                    'circle-opacity': 0.4,
                    'circle-blur': 0.5
                }
            });

            map.on('mouseenter', 'centros-puntos', () => {
                map.getCanvas().style.cursor = 'pointer';
            });

            map.on('mouseleave', 'centros-puntos', () => {
                map.getCanvas().style.cursor = '';
            });

            // --- LÒGICA DE CLIC OPTIMITZADA (INSTANTÀNEA) ---
            map.on('click', 'centros-puntos', (e) => {
                const coordinates = e.features[0].geometry.coordinates.slice();
                const props = e.features[0].properties;

                // 1. Gestionar popup existent
                if (currentPopup) {
                    currentPopup.off('close', resetMap); // Evitar doble reset
                    currentPopup.remove();
                    currentPopup = null;
                }

                // Normalitzar coordenades
                while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                    coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
                }

                // 2. CALCULAR OFFSET PER A "MARCADOR MÉS AVALL"
                // Un offset positiu en Y mou el punt de destí cap AVALL respecte al centre de la pantalla.
                // Usem 1/3 de l'alçada de la pantalla. Això deixa 2/3 lliures a dalt per al popup.
                const offsetY = window.innerHeight / 3;

                // 3. MOURE EL MAPA (ANIMACIÓ)
                map.flyTo({
                    center: coordinates,
                    zoom: 16,
                    speed: 1.5, // Més ràpid com en l'exemple que has passat
                    curve: 1,
                    offset: [0, offsetY], // Això baixa el marcador
                    essential: true
                });

                // 4. MOSTRAR POPUP INSTANTÀNIAMENT
                // No esperem al 'moveend'. El creem ja.
                const popupContent = `
                    <div class="popup-header">${props.Nombre}</div>
                    <div class="popup-body">
                        <div class="popup-row">
                            <strong>Carrer:</strong> 
                            <span>${props.Calle}</span>
                        </div>
                        <div class="popup-row">
                            <strong>Barris:</strong> 
                            <span>${props.Barrios}</span>
                        </div>
                        <div class="popup-img-container">
                            <div class="spinner"></div>
                            <img src="${props.Foto}" 
                                 class="popup-img" 
                                 alt="Foto del centre" 
                                 onload="this.previousElementSibling.style.display='none'"
                                 onerror="this.src='${backupImage}'; this.previousElementSibling.style.display='none'">
                        </div>
                    </div>
                `;

                // Creem el popup forçant l'àncora a baix (anchor: 'bottom')
                // Això garanteix que el popup surti cap AMUNT (above)
                // i no es col·loqui sota el marcador.
                const popup = new maplibregl.Popup({ 
                    offset: 25, 
                    closeButton: true, 
                    closeOnClick: true,
                    autoPan: false, // CLAU: Desactivem autoPan perquè ja movem nosaltres el mapa amb flyTo
                    anchor: 'bottom' // CLAU: Forcem que surti cap amunt
                })
                    .setLngLat(coordinates)
                    .setHTML(popupContent)
                    .addTo(map);

                // Reactivem el zoom out quan es tanqui aquest nou popup
                popup.on('close', resetMap);
                currentPopup = popup;
            });
        });
    </script>
</body>
</html>